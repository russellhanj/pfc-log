<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Project Full Cycle ‚Äî Quick Log</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<style>
:root{
  --bg:#ffffff; --card:#f2f4f7; --text:#0b0f1a; --muted:#5b6472;
  --primary:#2e5bff; --accent:#21c17a; --danger:#d92d20; --border:#e5e7eb;
  --radius:12px;
   --sticky-h: 108px;
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0e1116; --card:#151a22; --text:#f2f4f7; --muted:#a8b0bd; --border:#1f2430; }
}
*{box-sizing:border-box;-webkit-tap-highlight-color: transparent}
html,body{height:100%}

/* update body padding: */
/* update body padding (ADD top safe-area inset) */
body{
  margin:0;
  padding:
    calc(16px + env(safe-area-inset-top))   /* ‚Üê was 16px; add notch inset */
    env(safe-area-inset-right)
    calc(var(--sticky-h) + 24px + env(safe-area-inset-bottom))
    env(safe-area-inset-left);
  font:16px/1.4 -apple-system, system-ui, Segoe UI, Roboto, sans-serif;
  color:var(--text); background:var(--bg);
  -webkit-text-size-adjust:100%;
}

h1{font-size:20px;margin:0 0 12px}
.section{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; margin:12px 0; box-shadow:0 6px 24px rgba(0,0,0,.06)}
label{display:block; font-weight:600; font-size:14px; margin:8px 0 6px}
.helper{font-size:12px; color:var(--muted); margin-top:4px}
.row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
input,select,textarea{
  scroll-margin-bottom: calc(var(--sticky-h) + 32px);
  width:100%; padding:12px; border:1px solid var(--border); border-radius:10px;
  background:var(--bg); color:var(--text); font-size:16px; -webkit-appearance:none; appearance:none;
}
textarea{min-height:76px; resize:vertical}
.badge{display:inline-block; padding:2px 8px; font-size:12px; border-radius:999px; background:rgba(46,91,255,.12); color:var(--primary); margin-left:8px}
/* pin sticky above the iPhone home indicator */
.sticky{
  position:fixed;
  left:16px; right:16px;
  bottom: max(16px, env(safe-area-inset-bottom));
  padding:12px;
  border-radius:16px;
  background:var(--bg);
  border:1px solid var(--border);
  box-shadow:0 10px 30px rgba(0,0,0,.12);
  display:flex; gap:10px; align-items:center; z-index:10;
}
button{height:48px; padding:0 16px; border:0; border-radius:12px; font-weight:700; font-size:16px}
.primary{background:var(--primary); color:#fff; flex:1}
.secondary{background:var(--card); color:var(--text); border:1px solid var(--border)}
.msg{font-size:14px}
.ok{color:var(--accent)} .err{color:var(--danger)} .muted{color:var(--muted)}
.hidden{display:none!important}
.small{font-size:13px;color:var(--muted)}
/* Focus ring for clarity when tabbing via hardware keyboard */
input:focus, select:focus, textarea:focus { outline: 2px solid rgba(46,91,255,.35); outline-offset:2px }
</style>
</head>
<body>

<header style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
  <h1>Project Full Cycle <span class="badge">Quick Log</span></h1>
  <span class="small">iPhone-optimized</span>
</header>

<form id="logForm" novalidate autocomplete="off">
  <input type="password"
       autocomplete="new-password"
       tabindex="-1" aria-hidden="true"
       style="position:absolute;left:-9999px;opacity:0;width:0;height:0;">
  <!-- Prevent iOS from auto-filling fields -->
  <!-- Identity & Date -->
  <div class="section">
    <div class="row">
      <div>
        <label for="Date">Date</label>
        <input id="Date" name="Date" type="date" required
               autocomplete="off" enterkeyhint="next" tabindex="1" />
        <div class="helper">Defaults to today‚Äîtap to adjust</div>
      </div>
      <div>
        <label for="Project">Project</label>
        <input id="Project" name="Project" value="Full Cycle" readonly
               enterkeyhint="next" tabindex="-1" />
        <div class="helper">Locked</div>
      </div>
    </div>
    <div class="row">
      <div style="grid-column:1 / -1">
        <label for="Wake Up">Wake Up</label>
        <input id="Wake Up" name="Wake Up" type="time" value="05:00"
               autocomplete="off" enterkeyhint="next" tabindex="2" />
      </div>
    </div>
  </div>

  <!-- Sleep (_r fields as hh:mm durations) -->
  <div class="section">
    <div class="row">
      <div>
        <label for="Sleep Time">Sleep Time</label>
        <input id="Sleep Time" name="Sleep Time" type="time" value="21:30"
               autocomplete="off" enterkeyhint="next" tabindex="3" />
      </div>
      <div>
        <label for="Total Sleep Hours">Total Sleep Hours (hh:mm)</label>
        <input id="Total Sleep Hours" name="Total Sleep Hours" type="text"
               inputmode="numeric" placeholder="07:17" class="hhmm"
               autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false"
               enterkeyhint="next" tabindex="4" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="REM_r">REM_r (hh:mm)</label>
        <input id="REM_r"  name="REM_r"  type="text" inputmode="numeric" placeholder="02:03" class="hhmm"
               autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false"
               enterkeyhint="next" tabindex="5" />
      </div>
      <div>
        <label for="Core_r">Core_r (hh:mm)</label>
        <input id="Core_r" name="Core_r" type="text" inputmode="numeric" placeholder="04:26" class="hhmm"
               autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false"
               enterkeyhint="next" tabindex="6" />
      </div>
    </div>
    <div class="row">
      <div style="grid-column:1 / -1">
        <label for="Deep_r">Deep_r (hh:mm)</label>
        <input id="Deep_r" name="Deep_r" type="text" inputmode="numeric" placeholder="01:10" class="hhmm"
               autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false"
               enterkeyhint="next" tabindex="7" />
      </div>
    </div>

    <!-- Hidden non-_r fields -->
    <input class="hidden" id="Sleep Hours" name="Sleep Hours" />
    <input class="hidden" id="REM" name="REM" />
    <input class="hidden" id="Core" name="Core" />
    <input class="hidden" id="Deep" name="Deep" />
  </div>

  <!-- Dreams -->
  <div class="section">
    <div class="row">
      <div>
        <label for="Dream">Dream</label>
        <select id="Dream" name="Dream" enterkeyhint="next" tabindex="8">
          <option>None / Not remembered</option>
          <option>Vivid</option>
          <option>Horror / Fear</option>
          <option>Pleasure</option>
          <option>Creative / Problem-solving</option>
          <option>Emotional / Relationship</option>
          <option>Lucid / Aware</option>
          <option>Other / Random</option>
        </select>
      </div>
      <div>
        <label for="Dream note">Dream note</label>
        <input id="Dream note" name="Dream note" placeholder="(optional)"
               autocomplete="on" enterkeyhint="next" tabindex="9" />
      </div>
    </div>
  </div>

  <!-- Day -->
  <div class="section">
    <div class="row">
      <div>
        <label for="Morning Activity">Morning Activity</label>
        <input id="Morning Activity" name="Morning Activity" placeholder="1 hr walk / 5K run"
               autocomplete="on" enterkeyhint="next" tabindex="10" />
      </div>
      <div>
        <label for="Work/Energy">Work/Energy</label>
        <input id="Work/Energy" name="Work/Energy" placeholder="steady / crash at 2pm‚Ä¶"
               autocomplete="on" enterkeyhint="next" tabindex="11" />
      </div>
    </div>
    <div class="row">
      <div>
        <label for="Gym / Social">Gym / Social</label>
        <input id="Gym / Social" name="Gym / Social" placeholder="legs day; dinner w/ friends"
               autocomplete="on" enterkeyhint="next" tabindex="12" />
      </div>
      <div>
        <label for="Evening / Notes">Evening / Notes</label>
        <input id="Evening / Notes" name="Evening / Notes" placeholder="screen off 9:15; shower; journal; lights out 9:50"
               autocomplete="on" enterkeyhint="done" tabindex="13" />
      </div>
    </div>
  </div>

  <!-- Sticky submit -->
  <div class="sticky">
    <button class="secondary hidden" type="button" id="saveLocal">Save Local</button>
    <button class="primary" type="submit">Submit</button>
    <div class="msg" id="msg"></div>
  </div>
  <div aria-hidden="true" style="height: calc(var(--sticky-h) + 24px + env(safe-area-inset-bottom));"></div>
</form>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycby3LHstqBVwargOknQiUY57L-ndeUV6kVaGf_XnSC6xmslZWRv4lbpAVpO0ppLPE1hb/exec';

// 1) Defaults on load (Date today + Sleep Time 21:30 + Wake 05:00)
function setDefaults(){
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  const today = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const dateEl = document.getElementById('Date');
  if(!dateEl.value) dateEl.value = today;

  const sleepEl = document.getElementById('Sleep Time');
  if(!sleepEl.value) sleepEl.value = '21:30';

  const wakeEl = document.getElementById('Wake Up');
  if(!wakeEl.value) wakeEl.value = '05:00';
}
setDefaults();
(function(){
  const fields = document.querySelectorAll('#logForm input, #logForm select, #logForm textarea');
  fields.forEach(el => {
    el.setAttribute('autocomplete', 'off');
    el.setAttribute('autocorrect', 'off');
    el.setAttribute('autocapitalize', 'none');
    el.setAttribute('spellcheck', 'false');
  });
})();
// Measure sticky height -> set --sticky-h, keep it accurate on viewport/keyboard changes
function setStickyPadding(){
  const sticky = document.querySelector('.sticky');
  if(!sticky) return;
  const h = sticky.getBoundingClientRect().height;
  document.documentElement.style.setProperty('--sticky-h', `${h}px`);
}
setStickyPadding();
window.addEventListener('resize', setStickyPadding);
if (window.visualViewport) {
  visualViewport.addEventListener('resize', setStickyPadding);
}


// 2) Offline queue
const QUEUE_KEY = 'pfc_offline_queue_v2';
const enqueue = payload => {
  const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
  q.push({ ts: Date.now(), payload });
  localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
};

// --- Auto-format hh:mm for numeric keypad fields --- //
function maskToHHMM(el){
  let digits = el.value.replace(/\D/g, '').slice(0, 4);
  if (digits.length >= 3) {
    el.value = digits.slice(0, 2) + ':' + digits.slice(2);
  } else {
    el.value = digits;
  }
}
function clampHHMM(el){
  const m = /^(\d{1,2}):(\d{2})$/.exec(el.value.trim());
  if (!m) return;
  let hh = parseInt(m[1], 10);
  let mm = parseInt(m[2], 10);
  if (isNaN(mm) || mm > 59) mm = Math.min(Math.max(mm || 0, 0), 59);
  if (isNaN(hh) || hh > 23) hh = Math.min(Math.max(hh || 0, 0), 23);
  el.value = String(hh).padStart(2,'0') + ':' + String(mm).padStart(2,'0');
}
function bindHHMMMasks(){
  const fields = document.querySelectorAll('input.hhmm');
  fields.forEach(el => {
    el.addEventListener('input', () => maskToHHMM(el));
    el.addEventListener('blur',  () => clampHHMM(el));
  });
}
bindHHMMMasks();

// 3) Focus UX: Return -> Next, focus scroll, proper Done on last
const form = document.getElementById('logForm');
const msg = document.getElementById('msg');

// Build ordered list of focusable controls (skip readonly/hidden)
const focusables = Array.from(form.querySelectorAll('input:not([type="hidden"]):not([readonly]), select, textarea'))
  .filter(el => !el.classList.contains('hidden'))
  .sort((a,b) => (parseInt(a.getAttribute('tabindex')||'999',10) -
                  parseInt(b.getAttribute('tabindex')||'999',10)));

function scrollCenter(el){
  // Use block:center to keep field above the keyboard
  el.scrollIntoView({behavior:'smooth', block:'center'});
}

// Add listeners
focusables.forEach((el, idx) => {
  // Center on focus
  el.addEventListener('focus', () => scrollCenter(el), {passive:true});

  // Enter/Return key to advance (works for text/number; date/time pickers use Next on keyboard)
  el.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      e.preventDefault();
      const isLast = (idx === focusables.length - 1);
      if(isLast){
        // Last field -> submit
        form.requestSubmit();
      }else{
        // Focus next
        focusables[idx+1].focus({preventScroll:false});
      }
    }
  });

  // iOS: when select closes, go Next automatically (nice flow)
  if(el.tagName === 'SELECT'){
    el.addEventListener('change', () => {
      const isLast = (idx === focusables.length - 1);
      if(!isLast) focusables[idx+1].focus({preventScroll:false});
    });
  }
});

// 4) Auto-flush queue when online/visible
const flushQueue = async ()=>{
  const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
  if(!q.length) return;
  let okCount = 0;
  for(const item of q){
    try{
      await fetch(WEBAPP_URL,{ method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(item.payload) });
      okCount++;
    }catch(e){}
  }
  if(okCount===q.length) localStorage.removeItem(QUEUE_KEY);
};
window.addEventListener('online', flushQueue);
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') flushQueue(); });

// 5) Submit + Save Local
// document.getElementById('saveLocal').addEventListener('click', ()=>{
//   const data = Object.fromEntries(new FormData(form).entries());
//   sanitizeForR(data);
//   enqueue(data);
//   msg.textContent = 'Saved locally üì¶ (will sync when online)';
//   msg.className = 'msg ok';
// });
// 5) Submit + (optional) Save Local
const saveBtn = document.getElementById('saveLocal'); // may not exist (or may be hidden)
if (saveBtn) {
  saveBtn.addEventListener('click', () => {
    const data = Object.fromEntries(new FormData(form).entries());
    sanitizeForR(data);
    enqueue(data);
    msg.textContent = 'Saved locally üì¶ (will sync when online)';
    msg.className = 'msg ok';
  });
}


form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(form).entries());

  if(!data['Date']){
    msg.textContent = 'Please add Date.';
    msg.className = 'msg err';
    return;
  }
  data['Project'] = 'Full Cycle';
  sanitizeForR(data);

  msg.textContent = 'Saving‚Ä¶';
  msg.className = 'msg muted';

  try{
    await fetch(WEBAPP_URL,{
      method:'POST', mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    msg.textContent = 'Saved ‚úÖ';
    msg.className = 'msg ok';
    form.reset();
    document.getElementById('Project').value = 'Full Cycle';
    setDefaults();
    // Put focus back to Date for quick consecutive logging
    const first = document.querySelector('[tabindex="1"]');
    if(first) first.focus();
  }catch(err){
    enqueue(data);
    msg.textContent = 'Offline ‚Äî saved to device. Will sync later.';
    msg.className = 'msg ok';
  }
});

// Keep only _r stage durations
function sanitizeForR(obj){
  obj['Sleep Hours'] = '';
  obj['REM'] = '';
  obj['Core'] = '';
  obj['Deep'] = '';
}

flushQueue();
</script>
</body>
</html>
